version: '3'

vars:
  VENV_PY: '{{if eq OS "windows"}}backend\\.venv\\Scripts\\python.exe{{else}}backend/.venv/bin/python{{end}}'

tasks:
  bootstrap:
    desc: Create venv and install CLI dependencies
    cmds:
      - python -m venv backend/.venv
      - '{{.VENV_PY}} -m pip install -U pip'
      - '{{.VENV_PY}} -m pip install -r backend/requirements.txt'
      - cmd: powershell -NoProfile -Command "if (-not (Test-Path 'config.yaml')) { Copy-Item 'config.example.yaml' 'config.yaml' }"
        platforms: [windows]
      - cmd: sh -c 'test -f config.yaml || cp config.example.yaml config.yaml'
        platforms: [linux, darwin]

  cli:help:
    desc: Show CLI help
    deps: [bootstrap]
    env:
      PYTHONPATH: backend
    cmds:
      - '{{.VENV_PY}} -m app.cli --help'

  download:
    desc: Download Denmark buildings dataset to cache
    cmds:
      - cmd: python scripts/download_dk_buildings.py {{.CLI_ARGS}}
        platforms: [windows]
      - cmd: python3 scripts/download_dk_buildings.py {{.CLI_ARGS}}
        platforms: [linux, darwin]

  extract:skjern:
    desc: Extract buildings for Skjern bbox into GeoJSON
    deps: [bootstrap]
    cmds:
      - cmd: '{{.VENV_PY}} scripts\\extract_bbox.py --bbox 8.491938 55.947356 8.495377 55.949194 --out maps\\skjern.buildings.geojson --preview'
        platforms: [windows]
      - cmd: '{{.VENV_PY}} scripts/extract_bbox.py --bbox 8.491938 55.947356 8.495377 55.949194 --out maps/skjern.buildings.geojson --preview'
        platforms: [linux, darwin]
